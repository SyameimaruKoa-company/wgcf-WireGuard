name: WGCF Create with QR Code

on:
  workflow_dispatch:
    inputs:
      terminal_name:
        description: "è­˜åˆ¥ç”¨ã®åå‰ã‚’å…¥åŠ› (ãƒªãƒªãƒ¼ã‚¹å/ã‚¿ã‚°ç”¨)"
        required: true # ã“ã‚Œã¯å¿…é ˆã˜ã‚ƒ
      asset_name_suffix:
        description: "ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ› (ç©ºæ¬„OK)"
        required: false # ã“ã‚Œã¯å¿…é ˆã§ã¯ãªã„ã˜ã‚ƒ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦ã˜ã‚ƒ

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒªãƒã‚¸ãƒˆãƒª
        uses: actions/checkout@v4

      - name: Goã‚’è¨­å®šã™ã‚‹
        uses: actions/setup-go@v5
        with:
          go-version: 1.22

      - name: wgcf ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹
        run: |
          git clone https://github.com/ViRb3/wgcf.git
          cd wgcf
          go build -o wgcf
          sudo mv wgcf /usr/local/bin/

      - name: WGCFã«ç™»éŒ²ã™ã‚‹ï¼ˆéå¯¾è©±å‹ï¼‰
        run: |
          yes | wgcf register

      - name: WireGuardãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
        run: |
          wgcf generate

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
        run: |
          cp wgcf-profile.conf wgcf-profile-adguard.conf
          # Cloudflare DNSã‚’AdGuard DNSã«ç½®æ›ã™ã‚‹ã®ã˜ã‚ƒ
          sed -i 's/1.1.1.1/94.140.14.14/g' wgcf-profile-adguard.conf
          sed -i 's/1.0.0.1/94.140.15.15/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1111/2a10:50c0::ad1:ff/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1001/2a10:50c0::ad2:ff/g' wgcf-profile-adguard.conf

      - name: Google DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ (DNS64è¾¼ã¿)
        run: |
          cp wgcf-profile.conf wgcf-profile-google.conf
          # 'DNS = 'ã§å§‹ã¾ã‚‹è¡Œã‚’ä¸¸ã”ã¨ã€æŒ‡å®šã•ã‚ŒãŸGoogle DNSã‚¢ãƒ‰ãƒ¬ã‚¹å…¨ã¦ã«ç½®ãæ›ãˆã‚‹ã®ã˜ã‚ƒ
          sed -i '/^DNS = /c\DNS = 8.8.8.8, 8.8.4.4, 2001:4860:4860::8888, 2001:4860:4860::8844, 2001:4860:4860::6464, 2001:4860:4860::64' wgcf-profile-google.conf

      - name: å®Ÿè¡Œæ—¥æ™‚ã‚’å–å¾—ã™ã‚‹
        id: get_datetime
        run: echo "CURRENT_DATETIME=$(date +'%Y-%m-%d-%H%M%S')" >> $GITHUB_ENV

      - name: ã‚¿ã‚°ã¨ãƒªãƒªãƒ¼ã‚¹åç”¨ã«ç«¯æœ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹
        run: |
          SANITIZED_NAME=$(echo "${{ github.event.inputs.terminal_name }}" | sed 's/[[:space:]]/-/g')
          echo "SANITIZED_TERMINAL_NAME=$SANITIZED_NAME" >> $GITHUB_ENV

      - name: ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã®æ¥å°¾è¾ã‚’æ±ºå®šã™ã‚‹
        run: |
          ASSET_SUFFIX_INPUT="${{ github.event.inputs.asset_name_suffix }}"
          if [ -n "$ASSET_SUFFIX_INPUT" ]; then
            FINAL_SUFFIX="$ASSET_SUFFIX_INPUT"
          else
            FINAL_SUFFIX="${{ env.SANITIZED_TERMINAL_NAME }}"
          fi
          echo "FINAL_ASSET_SUFFIX=$FINAL_SUFFIX" >> $GITHUB_ENV
        shell: bash

      # --- ã“ã“ã‹ã‚‰ãŒå¤‰æ›´ç‚¹ã˜ã‚ƒ ---

      - name: qrencode ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
        run: sudo apt-get update && sudo apt-get install -y qrencode

      - name: QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã€ãƒªãƒªãƒ¼ã‚¹æœ¬æ–‡ã‚’ä½œæˆã™ã‚‹
        id: prepare_release_body
        run: |
          BODY_CONTENT="ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®QRã‚³ãƒ¼ãƒ‰ã˜ã‚ƒãã€‚ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹ã™ã‚‹ã®ã˜ã‚ƒã€‚"

          # Cloudflareãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®QRã‚³ãƒ¼ãƒ‰
          CF_QR_BASE64=$(qrencode -t png -o - < wgcf-profile.conf | base64 -w 0)
          BODY_CONTENT="${BODY_CONTENT}
          <details>
          <summary>WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.conf QRã‚³ãƒ¼ãƒ‰</summary>
          <br>
          ![QR Code](data:image/png;base64,${CF_QR_BASE64})
          </details>
          "

          # AdGuardãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®QRã‚³ãƒ¼ãƒ‰
          AG_QR_BASE64=$(qrencode -t png -o - < wgcf-profile-adguard.conf | base64 -w 0)
          BODY_CONTENT="${BODY_CONTENT}
          <details>
          <summary>WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.conf QRã‚³ãƒ¼ãƒ‰</summary>
          <br>
          ![QR Code](data:image/png;base64,${AG_QR_BASE64})
          </details>
          "

          # Googleãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®QRã‚³ãƒ¼ãƒ‰
          GO_QR_BASE64=$(qrencode -t png -o - < wgcf-profile-google.conf | base64 -w 0)
          BODY_CONTENT="${BODY_CONTENT}
          <details>
          <summary>WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.conf QRã‚³ãƒ¼ãƒ‰</summary>
          <br>
          ![QR Code](data:image/png;base64,${GO_QR_BASE64})
          </details>
          "

          # GITHUB_ENVã«è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’æ¸¡ã™ãŸã‚ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã˜ã‚ƒ
          echo 'RELEASE_BODY<<EOF' >> $GITHUB_ENV
          echo "${BODY_CONTENT}" >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV
        shell: bash

      - name: ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.SANITIZED_TERMINAL_NAME }}-${{ env.CURRENT_DATETIME }}
          release_name: ${{ env.CURRENT_DATETIME }}-${{ env.SANITIZED_TERMINAL_NAME }}
          body: ${{ env.RELEASE_BODY }} # ã“ã“ã§æœ¬æ–‡ã«QRã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€ã®ã˜ã‚ƒ
          draft: true
          prerelease: false

      # --- ã“ã“ã¾ã§ãŒå¤‰æ›´ç‚¹ã˜ã‚ƒ ---

      - name: Cloudflare DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        id: upload-cloudflare-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile.conf
          asset_name: WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        id: upload-adguard-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-adguard.conf
          asset_name: WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: Google DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        id: upload-google-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-google.conf
          asset_name: WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: Check if Discord Webhook Secret is Set
        id: check_secret
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "DISCORD_SECRET_SET=true" >> $GITHUB_ENV
          else
            echo "DISCORD_SECRET_SET=false" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Discordã«é€šçŸ¥ã‚’é€ã‚‹
        if: env.DISCORD_SECRET_SET == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: |
            ğŸ‰ WGCFãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒªãƒªãƒ¼ã‚¹ãŒå®Œäº†ã—ãŸã®ã˜ã‚ƒï¼ğŸ‰

            **ç«¯æœ«å (ãƒªãƒªãƒ¼ã‚¹/ã‚¿ã‚°ç”¨):** ${{ github.event.inputs.terminal_name }}
            **ãƒ•ã‚¡ã‚¤ãƒ«åæ¥å°¾è¾ (ã‚¢ã‚»ãƒƒãƒˆç”¨):** ${{ env.FINAL_ASSET_SUFFIX }}
            **å®Ÿè¡Œæ—¥æ™‚:** ${{ env.CURRENT_DATETIME }}
            **Runç•ªå·:** #${{ github.run_number }}

            ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ãƒªãƒªãƒ¼ã‚¹ã«æ·»ä»˜ã•ã‚ŒãŸã®ã˜ã‚ƒ (QRã‚³ãƒ¼ãƒ‰ä»˜ãï¼):
            - Cloudflare DNS
            - AdGuard DNS
            - Google DNS (DNS64è¾¼ã¿)

            **ãƒªãƒªãƒ¼ã‚¹URL:** ${{ steps.create_release.outputs.html_url }}
