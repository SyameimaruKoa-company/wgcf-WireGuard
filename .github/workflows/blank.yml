name: WGCFãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ

on:
  workflow_dispatch:
    inputs:
      terminal_name:
        description: "ç«¯æœ«ã®åå‰ã‚’å…¥åŠ›ã™ã‚‹ã®ã˜ã‚ƒ (ä¾‹: MyPhone)"
        required: true
        default: "UnnamedDevice"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦ã˜ã‚ƒ

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒªãƒã‚¸ãƒˆãƒª
        uses: actions/checkout@v4

      - name: Goã‚’è¨­å®šã™ã‚‹
        uses: actions/setup-go@v5
        with:
          go-version: 1.22

      - name: wgcf ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹
        run: |
          git clone https://github.com/ViRb3/wgcf.git
          cd wgcf
          go build -o wgcf
          sudo mv wgcf /usr/local/bin/

      - name: WGCFã«ç™»éŒ²ã™ã‚‹ï¼ˆéå¯¾è©±å‹ï¼‰
        run: |
          yes | wgcf register

      - name: WireGuardãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
        run: |
          wgcf generate

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
        run: |
          cp wgcf-profile.conf wgcf-profile-adguard.conf
          # Cloudflare DNSã‚’AdGuard DNSã«ç½®æ›ã™ã‚‹ã®ã˜ã‚ƒ
          sed -i 's/1.1.1.1/94.140.14.14/g' wgcf-profile-adguard.conf
          sed -i 's/1.0.0.1/94.140.15.15/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1111/2a10:50c0::ad1:ff/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1001/2a10:50c0::ad2:ff/g' wgcf-profile-adguard.conf

      - name: ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹
        id: get_date
        run: echo "CURRENT_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV #MMDDå½¢å¼ã§æ—¥ä»˜ã‚’å–å¾—ã—ã€ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹ã®ã˜ã‚ƒ

      - name: ã‚¿ã‚°ã®ç«¯æœ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹
        run: |
          SANITIZED_NAME=$(echo "${{ github.event.inputs.terminal_name }}" | sed 's/[[:space:]]/-/g')
          echo "SANITIZED_TERMINAL_NAME=$SANITIZED_NAME" >> $GITHUB_ENV

      - name: ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: wgcf-profile-${{ env.CURRENT_DATE }}-${{ github.run_number }}-${{ env.SANITIZED_TERMINAL_NAME }} # ã‚¿ã‚°ã¯å¿…é ˆãªã®ã§æ®‹ã™ãŒã€ã‚µãƒ‹ã‚¿ã‚¤ã‚ºåã‚’ä½¿ã†ã®ã˜ã‚ƒ
          release_name: WGCF Profile ${{ env.CURRENT_DATE }}-${{ env.SANITIZED_TERMINAL_NAME }} # ãƒªãƒªãƒ¼ã‚¹åã«æ—¥ä»˜ã€ç«¯æœ«åã€ãƒ©ãƒ³ç•ªå·ã‚’å…¥ã‚Œã‚‹ã®ã˜ã‚ƒ
          draft: false # ãƒ‰ãƒ©ãƒ•ãƒˆã§ã¯ãªãã€ã™ãã«å…¬é–‹ã™ã‚‹ã®ã˜ã‚ƒ
          prerelease: false

      - name: å‡ºåŠ›ãƒªãƒªãƒ¼ã‚¹URL
        run: |
          echo "Release URL: ${{ steps.create_release.outputs.html_url }}" # ãƒªãƒªãƒ¼ã‚¹URLã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹ã®ã˜ã‚ƒ

      - name: Cloudflare DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        id: upload-cloudflare-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile.conf
          asset_name: wgcf-profile-cloudflare-${{ github.event.inputs.terminal_name }}.conf # ç«¯æœ«åã¨DNSã‚µãƒ¼ãƒ“ã‚¹åã‚’å«ã‚ã‚‹ã®ã˜ã‚ƒ
          asset_content_type: text/plain

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        id: upload-adguard-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-adguard.conf
          asset_name: wgcf-profile-adguard-${{ github.event.inputs.terminal_name }}.conf # ç«¯æœ«åã¨DNSã‚µãƒ¼ãƒ“ã‚¹åã‚’å«ã‚ã‚‹ã®ã˜ã‚ƒ
          asset_content_type: text/plain

      - name: Discordã«é€šçŸ¥ã‚’é€ã‚‹
        uses: tsickert/discord-webhook@v7.0.0 # ã“ã‚Œã§é–“é•ã„ãªã‹ã‚ã†
        with:
          # GitHub Marketplaceã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆé€šã‚Šã€å¿…é ˆå…¥åŠ›ã¯ 'webhook-url' ã˜ã‚ƒ
          # Secretsã«ç™»éŒ²ã—ãŸWebhook URLå…¨ä½“ã‚’æŒ‡å®šã™ã‚‹ã®ã˜ã‚ƒãï¼
          # Secretsã®åå‰ã¯ã€ãŠã¬ã—ãŒç™»éŒ²ã—ãŸã‚‚ã®ã«åˆã‚ã›ã‚‹ã®ã˜ã‚ƒã€‚
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }} # ã“ã“ã«Webhook URLå…¨ä½“ãŒå…¥ã£ãŸSecretã‚’æŒ‡å®š

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã¯ 'content' ã¨ã„ã†å…¥åŠ›åã˜ã‚ƒ
          content: | # è¤‡æ•°è¡Œã§æ›¸ããªã‚‰ãƒ‘ã‚¤ãƒ—è¨˜å·(|)ã‚’ä½¿ã†ã®ãŒä¾¿åˆ©ã˜ã‚ƒ
            ğŸ‰ WGCFãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒªãƒªãƒ¼ã‚¹ãŒå®Œäº†ã—ãŸã®ã˜ã‚ƒï¼ğŸ‰

            **ç«¯æœ«å:** ${{ github.event.inputs.terminal_name }}
            **Runç•ªå·:** #${{ github.run_number }}

            **ãƒªãƒªãƒ¼ã‚¹URL:** ${{ steps.create_release.outputs.html_url }}

            ãŠã¬ã—ã€ç¢ºèªã—ã¦ãŠãã®ã˜ã‚ƒãã€‚

          # ãã®ä»–ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«è¼‰ã£ã¦ã„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å…¥åŠ›ã˜ã‚ƒï¼ˆå¿…è¦ãªã‚‰ä½¿ã†ã¨è‰¯ã„ï¼‰
          # username: GitHub Actions # ä¾‹: é€šçŸ¥æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¨­å®š
          # avatar-url: https://avatars.githubusercontent.com/u/44036562?s=200&v=4 # ä¾‹: ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¨­å®š
          # Embedsãªã©ã€ã‚‚ã£ã¨å‡ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã—ãŸã„å ´åˆã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¦è¨­å®šã™ã‚‹ã®ã˜ã‚ƒãã€‚