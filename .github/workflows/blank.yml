name: WGCF Create

on:
  workflow_dispatch:
    inputs:
      terminal_name:
        description: "識別用の名前を入力"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # リリースを作成し、ファイルをアップロードするために必要じゃ

    steps:
      - name: チェックアウトリポジトリ
        uses: actions/checkout@v4

      - name: Goを設定する
        uses: actions/setup-go@v5
        with:
          go-version: 1.22

      - name: wgcf をクローンしてビルドする
        run: |
          git clone https://github.com/ViRb3/wgcf.git
          cd wgcf
          go build -o wgcf
          sudo mv wgcf /usr/local/bin/

      - name: WGCFに登録する（非対話型）
        run: |
          yes | wgcf register

      - name: WireGuardプロファイルを生成する
        run: |
          wgcf generate

      - name: AdGuard DNSプロファイルを作成する
        run: |
          cp wgcf-profile.conf wgcf-profile-adguard.conf
          # Cloudflare DNSをAdGuard DNSに置換するのじゃ
          sed -i 's/1.1.1.1/94.140.14.14/g' wgcf-profile-adguard.conf
          sed -i 's/1.0.0.1/94.140.15.15/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1111/2a10:50c0::ad1:ff/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1001/2a10:50c0::ad2:ff/g' wgcf-profile-adguard.conf

      - name: Google DNSプロファイルを作成する (DNS64込み)
        run: |
          cp wgcf-profile.conf wgcf-profile-google.conf
          # 'DNS = 'で始まる行を丸ごと、指定されたGoogle DNSアドレス全てに置き換えるのじゃ
          sed -i '/^DNS = /c\DNS = 8.8.8.8, 8.8.4.4, 2001:4860:4860::8888, 2001:4860:4860::8844, 2001:4860:4860::6464, 2001:4860:4860::64' wgcf-profile-google.conf

      - name: 今日の日付を取得する
        id: get_date
        run: echo "CURRENT_DATE=$(date +'%Y%m%d')" >> $GITHUB_ENV #MMDD形式で日付を取得し、環境変数に設定するのじゃ

      - name: タグの端末名をサニタイズする
        run: |
          SANITIZED_NAME=$(echo "${{ github.event.inputs.terminal_name }}" | sed 's/[[:space:]]/-/g')
          echo "SANITIZED_TERMINAL_NAME=$SANITIZED_NAME" >> $GITHUB_ENV

      - name: アセット名用に端末名を切り詰める
        run: |
          # サニタイズされた名前を最初の20文字に切り詰めるのじゃ
          # ここを修正じゃ！
          TRUNCATED_TERMINAL_NAME=${SANITIZED_TERMINAL_NAME:0:20}
          echo "TRUNCATED_TERMINAL_NAME=$TRUNCATED_TERMINAL_NAME" >> $GITHUB_ENV



      - name: リリースを作成
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.SANITIZED_TERMINAL_NAME }} # タグは必須なので残す
          release_name: ${{ env.CURRENT_DATE }}-${{ env.SANITIZED_TERMINAL_NAME }} # リリース名
          draft: true # ドラフト
          prerelease: false

      - name: Cloudflare DNSプロファイルアセットをアップロードする
        id: upload-cloudflare-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile.conf
          asset_name: WARP-CloudFlare-${{ env.TRUNCATED_TERMINAL_NAME }}.conf # 切り詰めた端末名を使うのじゃ
          asset_content_type: text/plain

      - name: AdGuard DNSプロファイルアセットをアップロード
        id: upload-adguard-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-adguard.conf
          asset_name: WARP-AdGuard-${{ env.TRUNCATED_TERMINAL_NAME }}.conf # こちらも切り詰めた端末名を使うのじゃ
          asset_content_type: text/plain

      - name: Google DNSプロファイルアセットをアップロード
        id: upload-google-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-google.conf
          asset_name: WARP-Google-${{ env.TRUNCATED_TERMINAL_NAME }}.conf # 切り詰めた端末名を使うのじゃ
          asset_content_type: text/plain

      # Discord Webhook Secretが設定されているかチェックするステップを追加じゃ
      - name: Check if Discord Webhook Secret is Set
        id: check_secret
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "DISCORD_SECRET_SET=true" >> $GITHUB_ENV
          else
            echo "DISCORD_SECRET_SET=false" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Discordに通知を送る
        # ここに条件を追加するのじゃ！ Secretが設定されている場合のみ実行じゃ
        if: env.DISCORD_SECRET_SET == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }} # ここにWebhook URL全体が入ったSecretを指定
          content: | # 複数行で書くならパイプ記号(|)を使うのが便利じゃ
            🎉 WGCFプロファイルの生成とリリースが完了したのじゃ！🎉

            **端末名:** ${{ github.event.inputs.terminal_name }}
            **Run番号:** #${{ github.run_number }}

            以下のプロファイルが生成され、リリースに添付されたのじゃ:
            - Cloudflare DNS
            - AdGuard DNS
            - Google DNS (DNS64込み)

            **リリースURL:** ${{ steps.create_release.outputs.html_url }}

            おぬし、確認しておくのじゃぞ。

          # その他、ドキュメントに載っているオプションの入力じゃ（必要なら使うと良い）
          # username: GitHub Actions # 例: 通知時のユーザー名を設定
          # avatar-url: https://avatars.githubusercontent.com/u/44036562?s=200&v=4 # 例: アバター画像を設定
          # Embedsなど、もっと凝ったメッセージにしたい場合は、ドキュメントを見て設定するのじゃぞ。
