name: WGCF Create with QR Code

on:
  workflow_dispatch:
    inputs:
      terminal_name:
        description: "è­˜åˆ¥ç”¨ã®åå‰ã‚’å…¥åŠ› (ãƒªãƒªãƒ¼ã‚¹å/ã‚¿ã‚°ç”¨)"
        required: true # ã“ã‚Œã¯å¿…é ˆã˜ã‚ƒ
      asset_name_suffix:
        description: "ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ› (ç©ºæ¬„OK)"
        required: false # ã“ã‚Œã¯å¿…é ˆã§ã¯ãªã„ã˜ã‚ƒ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write # ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆãƒ»æ›´æ–°ã—ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã«å¿…è¦ã˜ã‚ƒ

    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒªãƒã‚¸ãƒˆãƒª
        uses: actions/checkout@v4

      - name: Goã‚’è¨­å®šã™ã‚‹
        uses: actions/setup-go@v5
        with:
          go-version: 1.22

      - name: wgcf ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹
        run: |
          git clone https://github.com/ViRb3/wgcf.git
          cd wgcf
          go build -o wgcf
          sudo mv wgcf /usr/local/bin/

      - name: WGCFã«ç™»éŒ²ã™ã‚‹ï¼ˆéå¯¾è©±å‹ï¼‰
        run: |
          yes | wgcf register

      - name: WireGuardãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
        run: |
          wgcf generate

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
        run: |
          cp wgcf-profile.conf wgcf-profile-adguard.conf
          sed -i 's/1.1.1.1/94.140.14.14/g' wgcf-profile-adguard.conf
          sed -i 's/1.0.0.1/94.140.15.15/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1111/2a10:50c0::ad1:ff/g' wgcf-profile-adguard.conf
          sed -i 's/2606:4700:4700::1001/2a10:50c0::ad2:ff/g' wgcf-profile-adguard.conf

      - name: Google DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ (DNS64è¾¼ã¿)
        run: |
          cp wgcf-profile.conf wgcf-profile-google.conf
          sed -i '/^DNS = /c\DNS = 8.8.8.8, 8.8.4.4, 2001:4860:4860::8888, 2001:4860:4860::8844, 2001:4860:4860::6464, 2001:4860:4860::64' wgcf-profile-google.conf

      - name: å®Ÿè¡Œæ—¥æ™‚ã‚’å–å¾—ã™ã‚‹
        id: get_datetime
        run: echo "CURRENT_DATETIME=$(date +'%Y-%m-%d-%H%M%S')" >> $GITHUB_ENV

      - name: ã‚¿ã‚°ã¨ãƒªãƒªãƒ¼ã‚¹åç”¨ã«ç«¯æœ«åã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹
        run: |
          SANITIZED_NAME=$(echo "${{ github.event.inputs.terminal_name }}" | sed 's/[[:space:]]/-/g')
          echo "SANITIZED_TERMINAL_NAME=$SANITIZED_NAME" >> $GITHUB_ENV

      - name: ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ã®æ¥å°¾è¾ã‚’æ±ºå®šã™ã‚‹
        run: |
          ASSET_SUFFIX_INPUT="${{ github.event.inputs.asset_name_suffix }}"
          if [ -n "$ASSET_SUFFIX_INPUT" ]; then
            FINAL_SUFFIX="$ASSET_SUFFIX_INPUT"
          else
            FINAL_SUFFIX="${{ env.SANITIZED_TERMINAL_NAME }}"
          fi
          echo "FINAL_ASSET_SUFFIX=$FINAL_SUFFIX" >> $GITHUB_ENV
        shell: bash
      
      # --- ã“ã“ã‹ã‚‰ãŒå¤‰æ›´ç‚¹ã˜ã‚ƒ ---

      - name: ã‚¿ã‚°åã‚’ç”Ÿæˆã™ã‚‹
        id: generate_tag
        run: echo "TAG_NAME=${{ env.SANITIZED_TERMINAL_NAME }}-${{ env.CURRENT_DATETIME }}" >> $GITHUB_ENV

      - name: qrencode ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
        run: sudo apt-get update && sudo apt-get install -y qrencode

      - name: QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ç”Ÿæˆã™ã‚‹
        run: |
          qrencode -t png -o WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.png < wgcf-profile.conf
          qrencode -t png -o WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.png < wgcf-profile-adguard.conf
          qrencode -t png -o WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.png < wgcf-profile-google.conf
        shell: bash

      - name: ãƒªãƒªãƒ¼ã‚¹ã‚’ã¾ãšä½œæˆã™ã‚‹ï¼ˆæœ¬æ–‡ã¯å¾Œã§æ›´æ–°ï¼‰
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: ${{ env.CURRENT_DATETIME }}-${{ env.SANITIZED_TERMINAL_NAME }}
          body: "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..." # ä»®ã®æœ¬æ–‡ã˜ã‚ƒ
          draft: true
          prerelease: false

      - name: Cloudflare DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile.conf
          asset_name: WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: AdGuard DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-adguard.conf
          asset_name: WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: Google DNSãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./wgcf-profile-google.conf
          asset_name: WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.conf
          asset_content_type: text/plain

      - name: Cloudflare QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_name: WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_content_type: image/png

      - name: AdGuard QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_name: WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_content_type: image/png

      - name: Google QRã‚³ãƒ¼ãƒ‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_name: WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}.png
          asset_content_type: image/png

      - name: ãƒªãƒªãƒ¼ã‚¹æœ¬æ–‡ã‚’QRã‚³ãƒ¼ãƒ‰ä»˜ãã§æ›´æ–°ã™ã‚‹
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const release_id = ${{ steps.create_release.outputs.id }};
            const tag_name = "${{ env.TAG_NAME }}";
            const cf_asset_name = "WARP-CloudFlare-${{ env.FINAL_ASSET_SUFFIX }}";
            const ag_asset_name = "WARP-AdGuard-${{ env.FINAL_ASSET_SUFFIX }}";
            const go_asset_name = "WARP-Google-${{ env.FINAL_ASSET_SUFFIX }}";

            // ã‚¢ã‚»ãƒƒãƒˆã®URLã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã˜ã‚ƒ
            function getAssetUrl(assetName) {
              return `https://github.com/${owner}/${repo}/releases/download/${tag_name}/${assetName}`;
            }

            const body = `ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨ã®QRã‚³ãƒ¼ãƒ‰ã˜ã‚ƒãã€‚ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹ã™ã‚‹ã®ã˜ã‚ƒã€‚

            <details>
            <summary>${cf_asset_name}.conf QRã‚³ãƒ¼ãƒ‰</summary>
            <br>
            <img src="${getAssetUrl(cf_asset_name + '.png')}" alt="${cf_asset_name} QR Code">
            </details>

            <details>
            <summary>${ag_asset_name}.conf QRã‚³ãƒ¼ãƒ‰</summary>
            <br>
            <img src="${getAssetUrl(ag_asset_name + '.png')}" alt="${ag_asset_name} QR Code">
            </details>

            <details>
            <summary>${go_asset_name}.conf QRã‚³ãƒ¼ãƒ‰</summary>
            <br>
            <img src="${getAssetUrl(go_asset_name + '.png')}" alt="${go_asset_name} QR Code">
            </details>
            `;

            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id,
              body
            });

      - name: Check if Discord Webhook Secret is Set
        id: check_secret
        run: |
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "DISCORD_SECRET_SET=true" >> $GITHUB_ENV
          else
            echo "DISCORD_SECRET_SET=false" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Discordã«é€šçŸ¥ã‚’é€ã‚‹
        if: env.DISCORD_SECRET_SET == 'true'
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          content: |
            ğŸ‰ WGCFãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨ãƒªãƒªãƒ¼ã‚¹ãŒå®Œäº†ã—ãŸã®ã˜ã‚ƒï¼ğŸ‰

            **ç«¯æœ«å (ãƒªãƒªãƒ¼ã‚¹/ã‚¿ã‚°ç”¨):** ${{ github.event.inputs.terminal_name }}
            **ãƒ•ã‚¡ã‚¤ãƒ«åæ¥å°¾è¾ (ã‚¢ã‚»ãƒƒãƒˆç”¨):** ${{ env.FINAL_ASSET_SUFFIX }}
            **å®Ÿè¡Œæ—¥æ™‚:** ${{ env.CURRENT_DATETIME }}
            **Runç•ªå·:** #${{ github.run_number }}

            ä»¥ä¸‹ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã€ãƒªãƒªãƒ¼ã‚¹ã«æ·»ä»˜ã•ã‚ŒãŸã®ã˜ã‚ƒ (QRã‚³ãƒ¼ãƒ‰ä»˜ãï¼):
            - Cloudflare DNS
            - AdGuard DNS
            - Google DNS (DNS64è¾¼ã¿)

            **ãƒªãƒªãƒ¼ã‚¹URL:** ${{ steps.create_release.outputs.html_url }}
